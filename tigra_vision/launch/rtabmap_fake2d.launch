<launch>
    <!-- Kinect cloud to laser scan -->
    <node pkg="depthimage_to_laserscan" type="depthimage_to_laserscan" name="depthimage_to_laserscan">
        <remap from="image" to="/rs_camera/depth/image_raw"/>
        <remap from="camera_info" to="/rs_camera/depth/camera_info"/>
        <!--        <remap from="camera_info" to="/rs_camera/color/camera_info"/>-->
        <remap from="scan" to="/rs_scan"/>
        <param name="range_max" type="double" value="10"/>
        <param name="scan_height" type="int" value="10"/>
    </node>

    <!-- SLAM -->
    <arg name="rgb_topic" default="/rs_camera/color/image_raw"/>
    <arg name="depth_topic" default="/rs_camera/depth/image_raw"/>
    <arg name="camera_info_topic" default="/rs_camera/color/camera_info"/>
    <arg name="scan_topic" default="/rs_scan"/>
    <arg name="odom_topic" default="/odometry/local/filtered"/>

    <arg name="database_path" default="rtabmap.db"/>
    <arg name="rtabmapviz" default="true"/>
    <!--    arg for gui: -d $(find rtabmap_ros)/launch/config/rgbd_gui.ini"-->
    <arg name="localization" default="true"/>
    <arg if="$(arg localization)" name="args" default=""/>
    <arg unless="$(arg localization)" name="args" default="--delete_db_on_start"/>
    <arg name="wait_for_transform" default="0.2"/>

    <group ns="rtabmap">
        <node name="rtabmap" pkg="rtabmap_ros" type="rtabmap" output="screen" args="$(arg args)">
            <param name="database_path" type="string" value="$(arg database_path)"/>

            <param name="frame_id" type="string" value="rs_camera_link"/>
            <param name="wait_for_transform_duration" type="double" value="$(arg wait_for_transform)"/>

            <param name="subscribe_depth" type="bool" value="true"/>
            <param name="subscribe_scan" type="bool" value="true"/>

            <!-- inputs -->
            <remap from="odom" to="$(arg odom_topic)"/>
            <remap from="scan" to="$(arg scan_topic)"/>
            <remap from="rgb/image" to="$(arg rgb_topic)"/>
            <remap from="depth/image" to="$(arg depth_topic)"/>
            <remap from="rgb/camera_info" to="$(arg camera_info_topic)"/>


            <!-- output -->
            <remap from="grid_map" to="/map"/>

            <!-- RTAB-Map's parameters -->
            <param name="RGBD/ProximityBySpace" type="string" value="false"/>
            <param name="RGBD/AngularUpdate" type="string" value="0.01"/>
            <param name="RGBD/LinearUpdate" type="string" value="0.01"/>
            <param name="RGBD/OptimizeFromGraphEnd" type="string" value="false"/>
            <param name="Reg/Force3DoF" type="string" value="true"/>
            <param name="Vis/MinInliers" type="string" value="12"/>
            <param name="Reg/Strategy" type="string" value="0"/> <!-- 0=Visual, 1=ICP, 2=Visual+ICP -->
            <param name="RGBD/SavedLocalizationIgnored" type="bool" value="true"/>
            <param name="GridGlobal/MinSize"           type="string" value="20"/>

            <!-- localization mode -->
            <param if="$(arg localization)" name="Mem/IncrementalMemory" type="string" value="false"/>
            <param unless="$(arg localization)" name="Mem/IncrementalMemory" type="string" value="true"/>
            <param name="Mem/InitWMWithAllNodes" type="string" value="$(arg localization)"/>
        </node>

        <!--        &lt;!&ndash;Vivisualization&ndash;&gt;-->
        <!--        <node if="$(arg vizual)" name="rtabmapviz" pkg="rtabmap_ros" type="rtabmapviz" output="screen">-->
        <!--            <param name="frame_id" value="rs_camera_link"/>-->
        <!--            <remap from="odom" to="/odometry/local/filtered"/>-->
        <!--        </node>-->

        <!-- visualization with rtabmapviz -->
        <node if="$(arg rtabmapviz)" pkg="rtabmap_ros" type="rtabmapviz" name="rtabmapviz"
              args="" output="screen">
            <param name="frame_id" value="rs_camera_link"/>
            <remap from="odom" to="/odometry/local/filtered"/>
            <param name="subscribe_depth" type="bool" value="true"/>
            <param name="subscribe_scan" type="bool" value="true"/>
            <param name="wait_for_transform_duration" type="double" value="$(arg wait_for_transform)"/>
            <remap from="odom" to="$(arg odom_topic)"/>
            <remap from="scan" to="$(arg scan_topic)"/>
            <remap from="rgb/image" to="$(arg rgb_topic)"/>
            <remap from="depth/image" to="$(arg depth_topic)"/>
            <remap from="rgb/camera_info" to="$(arg camera_info_topic)"/>

        </node>
    </group>
</launch>